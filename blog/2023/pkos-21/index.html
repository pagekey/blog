<!DOCTYPE html><html class="2xl:text-[20px]" dir="ltr" lang="en"><head><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1" name="viewport"><link href="/sitemap-index.xml" rel="sitemap"><link href="/_astro/favicon.EoKXths8.ico" rel="shortcut icon"><link href="/_astro/favicon.Ca94UIdJ.svg" rel="icon" type="image/svg+xml"><link href="/_astro/favicon.Ca94UIdJ.svg" rel="mask-icon" color="#8D46E7"><link href="/_astro/apple-touch-icon.Ctlcgf5O.png" rel="apple-touch-icon" sizes="180x180"><style>:root{--aw-font-sans:'InterVariable';--aw-font-serif:'InterVariable';--aw-font-heading:'InterVariable';--aw-color-primary:rgb(1 97 239);--aw-color-secondary:rgb(1 84 207);--aw-color-accent:rgb(109 40 217);--aw-color-text-heading:rgb(0 0 0);--aw-color-text-default:rgb(16 16 16);--aw-color-text-muted:rgb(16 16 16 / 66%);--aw-color-bg-page:rgb(255 255 255);--aw-color-bg-page-dark:rgb(3 6 32)}.dark{--aw-color-primary:rgb(1 97 239);--aw-color-secondary:rgb(1 84 207);--aw-color-accent:rgb(109 40 217);--aw-color-text-heading:rgb(247, 248, 248);--aw-color-text-default:rgb(229 236 246);--aw-color-text-muted:rgb(229 236 246 / 66%);--aw-color-bg-page:rgb(3 6 32)}.katex-html{display:none}html{--pagefind-ui-scale:1;--pagefind-ui-primary:rgb(1 97 239);--pagefind-ui-text:rgb(16 16 16);--pagefind-ui-background:rgb(255 255 255);--pagefind-ui-border:rgb(16 16 16 / 66%);--pagefind-ui-tag:rgb(16 16 16 / 66%);--pagefind-ui-border-width:2px;--pagefind-ui-border-radius:8px;--pagefind-ui-image-border-radius:8px;--pagefind-ui-image-box-ratio:3/2;--pagefind-ui-font:sans-serif}html.dark{--pagefind-ui-scale:1;--pagefind-ui-primary:rgb(1 97 239);--pagefind-ui-text:rgb(229 236 246);--pagefind-ui-background:rgb(3 6 32);--pagefind-ui-border:rgb(229 236 246 / 66%);--pagefind-ui-tag:rgb(229 236 246 / 66%);--pagefind-ui-border-width:2px;--pagefind-ui-border-radius:8px;--pagefind-ui-image-border-radius:8px;--pagefind-ui-image-box-ratio:3/2;--pagefind-ui-font:sans-serif}html.dark .pagefind-ui button{color:rgb(229 236 246)}html.dark .pagefind-ui button:hover{color:rgb(229 236 246);border-color:rgb(229 236 246)}.header-read{color:gray}</style><script>!function(){const e="system";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");const t=document.querySelectorAll("[data-aw-toggle-color-scheme] > input");t&&t.length&&t.forEach((t=>{t.checked="dark"!==e}))}e&&e.endsWith(":only")||(localStorage.theme,0)?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light")}()</script><title>OS21: More PCI + Getting Started with Storage (IDE, SATA) ‚Äî PageKey</title><meta content="üöÄ Let&#39;s take back tech." name="description"/><meta content="index,follow" name="robots"/><link href="https://pagekey.io/blog/2023/pkos-21" rel="canonical"/><meta content="OS21: More PCI + Getting Started with Storage (IDE, SATA)" property="og:title"/><meta content="üöÄ Let&#39;s take back tech." property="og:description"/><meta content="https://pagekey.io/blog/2023/pkos-21" property="og:url"/><meta content="article" property="og:type"/><meta content="http://i3.ytimg.com/vi/vNMJbqNZrHI/hqdefault.jpg" property="og:image"/><meta content="en" property="og:locale"/><meta content="PageKey" property="og:site_name"/><meta content="summary_large_image" name="twitter:card"/><meta content="@onwidget" name="twitter:site"/><meta content="@onwidget" name="twitter:creator"/><meta content="orcPxI47GSa-cRvY11tUe6iGg2IO_RPvnA1q95iEM3M" name="google-site-verification"><link href="/_astro/_page_.BDj0p3vH.css" rel="stylesheet"><style>#blog-sidebar[data-astro-cid-wo4vtnkt]{display:none;padding:1rem;position:relative}@media screen and (min-width:72rem){#blog-sidebar[data-astro-cid-wo4vtnkt]{display:block}}</style></head><body class="antialiased bg-page text-default tracking-tight"><div id="top"></div><header class="mx-auto w-full border-b border-gray-50/0 ease-in-out flex-none sticky top-0 transition-[opacity] z-40" data-aw-sticky-header id="header"><div class="absolute inset-0"></div><div class="mx-auto w-full max-w-7xl md:flex md:justify-between md:px-6 px-3 py-3 relative text-default"><div class="flex justify-between"><a href="/" class="flex items-center"><span class="font-bold dark:text-white md:text-xl ml-2 rtl:ml-0 rtl:mr-2 self-center text-2xl text-gray-900 whitespace-nowrap"><span id="pks-daily-emoji">üîë</span> PageKey</span><script>function getDailyEmoji(){const e=new Date,t=60*e.getTimezoneOffset()*1e3,n=e.getTime()-t,i=["üìÑ","üîë","üå©","üó£","üöÅ","üõé","üò≥","üêã","üìà","üöÄ","üõ∞Ô∏è","üì¢","üêò","üèÜ","üîã","ü¶Ä","üçç","üçá","‚õ∞","üêß","üéà"];return i[Math.floor(n/864e5)%i.length]}window.addEventListener("DOMContentLoaded",(()=>{document.getElementById("pks-daily-emoji").innerHTML=getDailyEmoji()}))</script></a><div class="flex items-center md:hidden"><button class="flex flex-col cursor-pointer group h-12 items-center justify-center rounded w-12" aria-label="Toggle Menu" data-aw-toggle-menu><span class="sr-only">Toggle Menu</span> <span class="transition duration-200 bg-black dark:bg-white ease h-0.5 my-1 opacity-80 rounded-full transform w-6 group-[.expanded]:rotate-45 group-[.expanded]:translate-y-2.5" aria-hidden="true"></span> <span class="transition duration-200 bg-black dark:bg-white ease h-0.5 my-1 opacity-80 rounded-full transform w-6 group-[.expanded]:opacity-0" aria-hidden="true"></span> <span class="transition duration-200 bg-black dark:bg-white ease h-0.5 my-1 opacity-80 rounded-full transform w-6 group-[.expanded]:-rotate-45 group-[.expanded]:-translate-y-2.5" aria-hidden="true"></span></button></div></div><nav aria-label="Main navigation" class="items-center md:w-auto w-full hidden md:flex md:mx-5 md:overflow-x-auto md:overflow-y-visible overflow-x-hidden overflow-y-auto text-default"><ul class="flex flex-col font-medium md:flex-row md:self-center md:text-[0.9375rem] md:w-auto text-xl tracking-[0.01rem] w-full"><li class=""><a href="/" class="flex px-4 dark:hover:text-white hover:text-link py-3 items-centers">Home</a></li><li class="dropdown"><button class="flex items-center dark:hover:text-white hover:text-link px-4 py-3">Products <svg class="rtl:ml-0 h-3.5 hidden md:inline ml-0.5 rtl:mr-0.5 w-3.5" data-icon="tabler:chevron-down" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:chevron-down"><path d="m6 9l6 6l6-6" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></symbol><use xlink:href="#ai:tabler:chevron-down"></use></svg></button><ul class="dark:md:bg-dark drop-shadow-xl dropdown-menu font-medium md:absolute md:backdrop-blur-md md:bg-white/90 md:hidden md:min-w-[200px] md:pl-0 pl-4 rounded"><li><a href="/products/boom" class="dark:hover:text-white hover:text-link block dark:hover:bg-gray-700 first:rounded-t last:rounded-b md:hover:bg-gray-100 px-5 py-2 whitespace-no-wrap">üí£ Boom Languages</a></li><li><a href="/products/keydo" class="dark:hover:text-white hover:text-link block dark:hover:bg-gray-700 first:rounded-t last:rounded-b md:hover:bg-gray-100 px-5 py-2 whitespace-no-wrap">‚úÖ KeyDo</a></li><li><a href="/products/pkos" class="dark:hover:text-white hover:text-link block dark:hover:bg-gray-700 first:rounded-t last:rounded-b md:hover:bg-gray-100 px-5 py-2 whitespace-no-wrap">üíª PageKey Operating System</a></li><li><a href="/products/pkvid" class="dark:hover:text-white hover:text-link block dark:hover:bg-gray-700 first:rounded-t last:rounded-b md:hover:bg-gray-100 px-5 py-2 whitespace-no-wrap">üé• PKVid</a></li><li><a href="/products/ptd" class="dark:hover:text-white hover:text-link block dark:hover:bg-gray-700 first:rounded-t last:rounded-b md:hover:bg-gray-100 px-5 py-2 whitespace-no-wrap">üéπ Plaintext DAW</a></li></ul></li><li class=""><a href="/blog" class="flex px-4 dark:hover:text-white hover:text-link py-3 items-centers">Blog</a></li><li class=""><a href="/team" class="flex px-4 dark:hover:text-white hover:text-link py-3 items-centers">Team</a></li></ul></nav><div class="items-center md:w-auto w-full hidden md:flex bottom-0 fixed justify-end left-0 md:mb-0 md:p-0 md:self-center md:static p-3 rtl:left-auto rtl:right-0"><div class="flex items-center justify-between md:w-auto w-full"><div class="flex"><button class="text-muted dark:text-gray-400 dark:focus:ring-gray-700 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex items-center p-2.5 rounded-lg text-sm" aria-label="Toggle between Dark and Light mode" data-aw-toggle-color-scheme type="button"><svg class="w-6 h-6 md:h-5 md:inline-block md:w-5" data-icon="tabler:sun" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:sun"><path d="M8 12a4 4 0 1 0 8 0a4 4 0 1 0-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7l-.7.7m0 11.4l.7.7m-12.1-.7l-.7.7" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></symbol><use xlink:href="#ai:tabler:sun"></use></svg></button> <a href="/search" class="text-muted dark:text-gray-400 dark:focus:ring-gray-700 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex items-center p-2.5 rounded-lg text-sm" aria-label="Search"><svg class="h-5 w-5" data-icon="tabler:search" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:search"><path d="M3 10a7 7 0 1 0 14 0a7 7 0 1 0-14 0m18 11l-6-6" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></symbol><use xlink:href="#ai:tabler:search"></use></svg></a></div></div></div></div></header><main><script>var topOffset=0;window.addEventListener("load",(function(){const e=window.getComputedStyle(document.getElementById("single-post-section"),null).getPropertyValue("padding-top").replace("px",""),t=document.getElementById("header").getBoundingClientRect().height;topOffset=parseInt(e)+1.5*t;document.querySelectorAll("#post-content h2, #post-content h3").forEach((function(e){console.log(e.tagName),"H2"==e.tagName?document.getElementById("ul-contents").innerHTML+=`<li id="li-${e.id}"><a href="#${e.id}">${e.innerText}</a></li>`:"H3"==e.tagName&&(document.getElementById("ul-contents").innerHTML+=`<li id="li-${e.id}" class='ml-4'><a href="#${e.id}">${e.innerText}</a></li>`)}))})),window.addEventListener("scroll",(function(e){window.scrollY>topOffset?document.getElementById("blog-sidebar").style.top=window.scrollY-topOffset/2+"px":document.getElementById("blog-sidebar").style.top="0";document.querySelectorAll("#post-content h2, #post-content h3").forEach((function(e){window.scrollY>e.offsetTop?document.getElementById(`li-${e.id}`).classList.add("header-read"):document.getElementById(`li-${e.id}`).classList.remove("header-read")}))}))</script><section class="flex lg:py-20 justify-center mx-auto py-8 sm:py-16" data-astro-cid-wo4vtnkt id="single-post-section"><article data-astro-cid-wo4vtnkt id="single-post"><header class="" data-astro-cid-wo4vtnkt><div class="mb-2 flex flex-col justify-between max-w-3xl mt-0 mx-auto px-4 sm:flex-row sm:items-center sm:px-6" data-astro-cid-wo4vtnkt><p data-astro-cid-wo4vtnkt><svg class="inline-block -mt-0.5 dark:text-gray-400 h-4 w-4" data-icon="tabler:clock" height="1em" viewBox="0 0 24 24" width="1em" data-astro-cid-wo4vtnkt><symbol id="ai:tabler:clock"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0-18 0"/><path d="M12 7v5l3 3"/></g></symbol><use xlink:href="#ai:tabler:clock"></use></svg> <time class="inline-block" data-astro-cid-wo4vtnkt datetime="Mon Jul 10 2023 00:00:00 GMT+0000 (Coordinated Universal Time)">Jul 10, 2023</time> ¬∑ <svg class="inline-block -mt-0.5 dark:text-gray-400 h-4 w-4" data-icon="tabler:user" height="1em" viewBox="0 0 24 24" width="1em" data-astro-cid-wo4vtnkt><symbol id="ai:tabler:user"><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0-8 0M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></symbol><use xlink:href="#ai:tabler:user"></use></svg> <span class="inline-block" data-astro-cid-wo4vtnkt>Steve Grice</span> ¬∑ <a href="/category/pagekey-operating-system" class="inline-block capitalize hover:underline" data-astro-cid-wo4vtnkt>pagekey operating system </a>&nbsp;¬∑ <span data-astro-cid-wo4vtnkt>11</span> min read</p></div><h1 class="mx-auto sm:px-6 max-w-3xl px-4 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter" data-astro-cid-wo4vtnkt>OS21: More PCI + Getting Started with Storage (IDE, SATA)</h1><p class="text-muted dark:text-slate-400 max-w-3xl mb-8 md:text-2xl mt-4 mx-auto px-4 sm:px-6 text-justify text-xl" data-astro-cid-wo4vtnkt></p><img alt="" decoding="async" height="506" loading="eager" src="http://i3.ytimg.com/vi/vNMJbqNZrHI/hqdefault.jpg" width="900" class="mx-auto bg-gray-400 dark:bg-slate-700 lg:max-w-[900px] max-w-full mb-6 sm:rounded-md" sizes="(max-width: 900px) 400px, 900px" style="object-fit:cover;object-position:center;max-width:900px;max-height:506px;aspect-ratio:1.7786561264822134;width:100%" data-astro-cid-wo4vtnkt></header><div class="mx-auto sm:px-6 max-w-3xl px-6 mt-8 dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert lg:prose-xl prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:scroll-mt-[80px] prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow-lg prose-md" data-astro-cid-wo4vtnkt id="post-content"><p><a href="./es">Tambi√©n disponible en espa√±ol</a></p><div class="w-full overflow-hidden text-center"><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen frameborder="0" height="315" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/vNMJbqNZrHI" style="margin:auto;border-radius:10px" title="YouTube video player" width="560"></iframe></div><p>Our entire world runs on computers, but few understand how they work at the lowest level. Everything, from your phone and laptop to the flight controllers on an airliner, has at least one computer chip in it called the CPU, which tells it what to do.</p><p>The operating system is supposed to handle all of the low-level operations, including interfacing with hardware. But what does that interface actually look like? It‚Äôs easy enough to write a file using <code>file.write()</code> in Python, but this is just an abstraction for what‚Äôs really happening. Somewhere, under the covers of layers and layers of abstraction, there‚Äôs a metal disk spinning, or an solid state drive, and you‚Äôre rearranging zeros and ones on that drive.</p><p>In this series, we throw away all of those comfortable abstractions that are provided to us and do bare-metal programming. Our code runs directly on the processor - there‚Äôs no standard library, there are no system calls, there‚Äôs no API other than the processor itself. If figuring out how to make things happen with <strong>only</strong> the processor and nothing else sounds exciting to you, then this series is for you.</p><p>PKOS stands for PageKey Operating System, which is an operating system built from scratch, on video, with each lesson learned along the way explained so that you can easily understand it and apply it to your own projects.</p><p>In this lesson, we continue our exploration of PCI, clean up the codebase a bit, attempt (unsuccessfully) to use Rust, and begin researching how to write a storage device driver.</p><h2 id="what-we-did">What We Did</h2><p>Here‚Äôs a quick summary of what was accomplished since the last video. The most important additions will be expanded upon in the Deep Dives section below.</p><ul><li>Significantly refined <code>pci.c</code><ul><li>Added <code>struct PCI_Device</code></li></ul></li><li>Code improvements<ul><li>Easier int-to-string calls</li><li>Screen wrap</li></ul></li><li>Rust sidequest: unsuccessful</li><li>Researched IDE drivers</li><li>Researched SATA drivers</li><li>Attached SATA device to QEMU</li></ul><h2 id="lessons-learned">Lessons Learned</h2><p>Working through the code for this video yielded a ton of great lessons. Here‚Äôs what I found:</p><h3 id="structs-are-wonderful">Structs are wonderful</h3><p>I was dragging my feet on implementing a struct to hold the PCI device data I was grabbing from the configuration memory, but I was amazed at how easy it was to do and how much cleaner the code got when I did. Just look at this lovely little struct:</p><pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#f97583">struct</span><span style="color:#e1e4e8"> PCI_Device {</span></span>
<span class="line"><span style="color:#e1e4e8">    u16 vendor_id;</span></span>
<span class="line"><span style="color:#e1e4e8">    u16 device_id;</span></span>
<span class="line"><span style="color:#e1e4e8">    u8 base_class;</span></span>
<span class="line"><span style="color:#e1e4e8">    u8 sub_class;</span></span>
<span class="line"><span style="color:#e1e4e8">    u8 prog_interface;</span></span>
<span class="line"><span style="color:#e1e4e8">    u16 command;</span></span>
<span class="line"><span style="color:#e1e4e8">    u16 status;</span></span>
<span class="line"><span style="color:#e1e4e8">};</span></span>
<span class="line"></span></code></pre><p>With this in place, I was able to abstract away all of the bitshifting that was required to get this data from the PCI configuration memory and just return the finished object. This made the implementation of <code>lspci()</code> much cleaner and easier to read, and it will avoid duplicating code when we write the storage device driver.</p><h3 id="pci-class-and-subclass-identify-device-function">PCI Class and Subclass: Identify device function</h3><p>Every PCI device has a Vendor ID and a Device ID, and you can use these two numbers to look up exactly what that device is - just type it in on <a href="https://www.pcilookup.com/">pcilookup.com</a> and see what you come up with!</p><h3 id="rust-bare-metal-i686-support-is-dodgy">Rust bare-metal i686 support is dodgy</h3><p>I was sad to find that 32-bit x86, also known is i386 or i686, does not have the best support in Rust for bare-metal programming. There is no default <code>i686-unknown-none</code> toolchain, which means that you have to define your own based off of the <code>i686-unknown-linux-gnu</code>. I tried my best, but couldn‚Äôt seem to get a multiboot kernel to compile.</p><p>I‚Äôd love to use Rust if I could figure it out, but it wasn‚Äôt in the cards for this episode - we‚Äôll stick to the simplicity of C for now.</p><h3 id="storage-drivers-ide-pata-and-ahci-sata-are-very-different">Storage Drivers: IDE (PATA) and AHCI (SATA) are very different</h3><p>I spent a fair amount of time trying to get the IDE controller that was attached to QEMU by default working. I‚Äôm not sure if it‚Äôs actually what I need - it seemed to be a cdrom drive.</p><p>From what I gathered, IDE/PATA is no longer used for hard drives, but may still be used for CDs. SATA/AHCI, on the other hand, are still very much relevant. See the deep dives below for more information on these technologies.</p><h2 id="deep-dives">Deep Dives</h2><p>Let‚Äôs dive into the details of the code for this episode.</p><h3 id="parsing-pci-fields-into-struct">Parsing PCI Fields into Struct</h3><p>The PCI configuration memory layout was essential in figuring out how to parse the fields:</p><p><img alt="PCI Configuration Memory" decoding="async" height="945" loading="lazy" src="/_astro/PCI_Configuration_Space.CI6-n0GJ_ICsla.webp" width="1024"></p><p>Recall that we have a working <code>read_pci_port</code> function at our disposal, and it takes four single-byte arguments: <code>bus</code>, <code>slot</code>, <code>function</code>, and <code>offset</code>. For a given PCI device, we can make multiple calls to this function, changing the <code>offset</code> field to grab the variables we want out of the structure above. For example, here‚Äôs a snippet of how we get the vendor and device ID:</p><pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#f97583">struct</span><span style="color:#e1e4e8"> PCI_Device device;</span></span>
<span class="line"><span style="color:#e1e4e8">u32 pci_data </span><span style="color:#f97583">=</span><span style="color:#b392f0"> read_pci_port</span><span style="color:#e1e4e8">(bus, slot, function, </span><span style="color:#79b8ff">0</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">device.vendor_id </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> pci_data </span><span style="color:#f97583">&amp;</span><span style="color:#f97583"> 0x</span><span style="color:#79b8ff">ffff</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">device.device_id </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (pci_data </span><span style="color:#f97583">&gt;&gt;</span><span style="color:#79b8ff"> 16</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;</span><span style="color:#f97583"> 0x</span><span style="color:#79b8ff">ffff</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span></code></pre><p>As you can see, we grab 32-bits at offset 0, then bitshift/AND the result until we isolate the fields that we need.</p><p>Check out this early look at the lspci method:</p><p><img alt="LSPCI Early Output" decoding="async" height="1974" loading="lazy" src="/_astro/lspci_output_early.Bt59UzoM_ZXncnh.webp" width="2704"></p><p>It looks great! The only problem is that there are quite a few devices with Vendor ID ‚Äúpppp.‚Äù That can‚Äôt be right - so what‚Äôs going on here? Well‚Ä¶</p><h3 id="ignoring-non-existent-pci-devices">Ignoring Non-Existent PCI Devices</h3><p>The Linux kernel finds non-existent PCI devices by checking if the PCI class field is set to <code>0xFFFFFFFF</code> <sup><a href="#user-content-fn-1" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-1">1</a></sup>. OSDev mentions that you can also check whether the Vendor ID field is set to <code>0xFFFF</code> <sup><a href="#user-content-fn-2" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-2">2</a></sup>. Though both probably work, I went with the latter technique. Applying this knowledge will save our <code>lspci()</code> function some work by skipping any further processing when it detects a nonexistent device:</p><pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#f97583">struct</span><span style="color:#e1e4e8"> PCI_Device device </span><span style="color:#f97583">=</span><span style="color:#b392f0"> get_pci_device</span><span style="color:#e1e4e8">(i, j, k);</span></span>
<span class="line"><span style="color:#f97583">if</span><span style="color:#e1e4e8"> (device.vendor_id </span><span style="color:#f97583">==</span><span style="color:#f97583"> 0x</span><span style="color:#79b8ff">FFFF</span><span style="color:#e1e4e8">) {</span></span>
<span class="line"><span style="color:#f97583">	continue</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">}</span></span>
<span class="line"></span></code></pre><p>Now we only see a few devices, and none of them have invalid fields for Vendor ID anymore!</p><p><img alt="LSPCI Output" decoding="async" height="453" loading="lazy" src="/_astro/lspci_output.BAXnuR8f_F490o.webp" width="715"></p><h3 id="looking-up-pci-devices">Looking Up PCI Devices</h3><p>Looking at the above screenshot, how much can you tell about the devices listed? At first, I had no clue where to start with deciphering these fields. However, a quick search showed me that I can use <a href="https://www.pcilookup.com/">pcilookup.com</a> to find out what each of these devices are. For example, looking up Vendor ID 8086 and Device 7010 yields:</p><p><img alt="PCI Lookup" decoding="async" height="92" loading="lazy" src="/_astro/pcilookup.x5-tZ3sg_1DlmfF.webp" width="1707"></p><p>This matches up with the QEMU documentation, and with the output of <code>info qtree</code>, so it seems like our <code>lspci()</code> method is accurate.</p><h3 id="pci-base-class-subclass-and-programming-interface">PCI Base Class, Subclass, and Programming Interface</h3><p>The PCI fields list above shows one big 3-byte chunk for ‚ÄúClass Code,‚Äù but documentation sometimes referred to the ‚Äúsubclass‚Äù field, which I couldn‚Äôt seem to find anywhere. However, it did seem to be a powerful way to tell what type of device you were dealing with - as an example, class 1 indicates a mass storage device, and class 1 subclass 1 indicates an IDE interface <sup><a href="#user-content-fn-3" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-3">3</a></sup>.</p><p>The specification documents for PCI don‚Äôt seem to be freely available online - you have to login to PCI-SIG‚Äôs website to download any of them. However, someone hosted the ‚ÄúPCI Local Bus Specification‚Äù from 2004 on their website <sup><a href="#user-content-fn-4" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-4">4</a></sup>, so I was able to take a look. On page 217, we see:</p><blockquote><p>The Class Code register is read-only and is used to identify the generic function of the device and, in some cases, a specific registerlevel programming interface. The register is broken into three bytesize fields. The upper byte (at offset 0Bh) is a base class code which broadly classifies the type of function the device performs. The middle byte (at offset 0Ah) is a sub-class code which identifies more specifically the function of the device. The lower byte (at offset 09h) identifies a specific register-level programming interface (if any) so that device independent software can interact with the device. Encodings for base class, sub-class, and programming interface are provided in Appendix D. All unspecified encodings are reserved.</p></blockquote><p>So, this just means that the three bytes allocated for ‚ÄúClass Code‚Äù are one byte each, representing base class at <code>0x0b</code>, subclass at <code>0x0a</code>, and programming interface at <code>0x09</code>. Simple enough! We can parse those fields with this snippet:</p><pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#e1e4e8">pci_data </span><span style="color:#f97583">=</span><span style="color:#b392f0"> read_pci_port</span><span style="color:#e1e4e8">(bus, slot, function, </span><span style="color:#f97583">0x</span><span style="color:#79b8ff">09</span><span style="color:#e1e4e8">);</span></span>
<span class="line"><span style="color:#e1e4e8">device.base_class </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (pci_data </span><span style="color:#f97583">&gt;&gt;</span><span style="color:#79b8ff"> 16</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;</span><span style="color:#f97583"> 0x</span><span style="color:#79b8ff">ff</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">device.sub_class </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> (pci_data </span><span style="color:#f97583">&gt;&gt;</span><span style="color:#79b8ff"> 8</span><span style="color:#e1e4e8">) </span><span style="color:#f97583">&amp;</span><span style="color:#f97583"> 0x</span><span style="color:#79b8ff">ff</span><span style="color:#e1e4e8">;</span></span>
<span class="line"><span style="color:#e1e4e8">device.prog_interface </span><span style="color:#f97583">=</span><span style="color:#e1e4e8"> pci_data </span><span style="color:#f97583">&amp;</span><span style="color:#f97583"> 0x</span><span style="color:#79b8ff">ff</span><span style="color:#e1e4e8">;</span></span>
<span class="line"></span></code></pre><p>I cheated a little bit by reading with offset <code>0x09</code> to save some bitshifting. I‚Äôm not sure if there is some kind of performance impact for not reading at 4-byte boundaries. There probably is, but for our purposes, does it really matter?</p><h3 id="attempts-to-use-rust">Attempts to use Rust</h3><p>I attempted to create a multiboot i386 kernel using Rust. If I had been successful, I could have linked in all of the existing C and assembly code into that executable, and any new development could have been in Rust! Unfortunately, I hit some roadblocks.</p><p>A StackOverflow answer by phip1611 <sup><a href="#user-content-fn-5" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-5">5</a></sup> informed me that while there‚Äôs no built-in target for bare-metal 32-bit x86 code, you can define a custom target by putting a JSON file at the root of the project and pointing to it in <code>.cargo/config.toml</code>. Using the <code>#![no_std]</code> and <code>#![no_main]</code> macros turn off the standard library and main method, which enable bare-metal execution.</p><p>I also found an awesome tutorial called ‚ÄúWriting an OS in Rust‚Äù <sup><a href="#user-content-fn-6" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-6">6</a></sup> which explained each piece of the puzzle very clearly. However, the whole tutorial was written for x86_64. Maybe the time to upgrade PKOS is coming, but I‚Äôm not ready to let go of 32-bit yet.</p><p>After messing with <code>xargo</code> for cross compiling for quite a while, I finally gave up on this path - for now.</p><h3 id="what-is-ide">What is IDE?</h3><p>IDE stands for Integrated Drive Electronics. It‚Äôs an electrical standard for disk storage devices released in 1990. It was originally referred to as Advanced Technology Attachment (ATA), but after the introduction of Serial ATA (SATA), it was renamed to Parallel ATA (PATA) <sup><a href="#user-content-fn-7" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-7">7</a></sup>.</p><p>We can identify IDE devices using the Class Code field in the PCI configuration space. OSDev wiki <sup><a href="#user-content-fn-8" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-8">8</a></sup> tells us:</p><blockquote><p>If the class code is 0x01 (Mass Storage Controller) and the subclass code is 0x01 (IDE), the device is an IDE controller.</p></blockquote><p>This takes care of the first two fields, but what about that pesky Programming Interface byte? I found something that says it‚Äôs used to indicate whether the primary and secondary storage devices are programmable, as well as their operating mode <sup><a href="#user-content-fn-9" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-9">9</a></sup>.</p><p><img alt="IDE Class Code" decoding="async" height="263" loading="lazy" src="/_astro/ide_class_code.DF5iYs00_Z1W0sIP.webp" width="493"></p><p><em>Photo Credits: <sup><a href="#user-content-fn-9" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-9-2">9</a></sup></em></p><p>I was able to find the specification for a PCI IDE card online, and I particularly enjoyed seeing that the class codes matched up with what I had seen so far from other sources:</p><p><img alt="Example PCI Card Spec Snippet" decoding="async" height="97" loading="lazy" src="/_astro/example_pci_card_spec_snippet.CgW7V0n7_ZyLxyA.webp" width="643"></p><p><em>Photo Credits: <sup><a href="#user-content-fn-11" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-11">10</a></sup></em></p><p>Another potentially helpful resource was a guide for writing an IDE driver from the RTEMS real time operating system‚Äôs documentation <sup><a href="#user-content-fn-12" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-12">11</a></sup>. I was also able to find the source code on GitHub <sup><a href="#user-content-fn-13" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-13">12</a></sup>. It seems like the ATA driver in <code>ata.c</code> uses the (perhaps) lower-level functions in <code>ide_controller.c</code>, but I‚Äôm not quite sure.</p><p>RTEMS provides a separate guide for writing an ATA driver <sup><a href="#user-content-fn-16" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-16">13</a></sup>. OSDev has one too <sup><a href="#user-content-fn-17" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-17">14</a></sup>. This is confusing, because the TechTarget article <sup><a href="#user-content-fn-7" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-7-2">7</a></sup> seems to indicate that ATA and IDE are basically interchangeable.</p><h3 id="what-is-sata">What is SATA?</h3><p>SATA stands for Serial Advanced Technology Attachment, defined, as noted above, in contrast to IDE/PATA. AHCI stands for Advanced Host Controller Interface. I‚Äôve seen these two acronyms used interchangeably in some of the drivers I saw online. However, Dell indicates that it may be more complicated to support an AHCI device than a SATA device <sup><a href="#user-content-fn-11" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-11-2">10</a></sup>.</p><p><img alt="PATA vs SATA" decoding="async" height="346" loading="lazy" src="/_astro/pata_vs_sata.DZJZTq1k_Z1hgFAU.webp" width="449"> <em>Photo credits: TechTarget <sup><a href="#user-content-fn-7" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-7-3">7</a></sup></em></p><h3 id="adding-sata-to-qemu">Adding SATA to QEMU</h3><p>A Stack Overflow answer by mwfearnley <sup><a href="#user-content-fn-14" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-14">15</a></sup> notes how to explicitly add a SATA device to QEMU:</p><pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0"><code><span class="line"><span>-drive id=disk,file=IMAGE.img,if=none \</span></span>
<span class="line"><span>-device ahci,id=ahci \</span></span>
<span class="line"><span>-device ide-hd,drive=disk,bus=ahci.0</span></span>
<span class="line"><span></span></span></code></pre><p>I appended these lines to the <code>os.py</code> script‚Äôs <code>run</code> and <code>run_debug</code> methods and, lo and behold, the SATA drive appeared in <code>lspci</code>! It‚Äôs on Bus 0, Device 4, Function 0 in the image below:</p><p><img alt="LSPCI Output" decoding="async" height="453" loading="lazy" src="/_astro/lspci_output.BAXnuR8f_F490o.webp" width="715"></p><p>Ruben Schade highlighted a similar technique for adding the drive in his blog <sup><a href="#user-content-fn-15" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-15">16</a></sup>. It also seems like it may have been enough to simply add <code>-hda IMAGE.img</code> to the QEMU run command, but since I did it the complicated way first and it worked, I just stuck with it.</p><h2 id="wrap-up">Wrap-Up</h2><p>Even though I didn‚Äôt quite get as far as I‚Äôd hoped in this episode, I still made some progress and learned a lot. I hope you enjoyed it and learned something too!</p><p>Next steps for this project will likely be trying to get some sort of SATA driver working, though from what I‚Äôve seen so far, I‚Äôm a little intimidated by how complex it can get. We‚Äôll see where things go!</p><p>If you enjoyed this post, consider subscribing to the <a href="https://youtube.com/@PageKey">PageKey YouTube channel</a>.</p><p>Additional source: <sup><a href="#user-content-fn-10" aria-describedby="footnote-label" data-footnote-ref="" id="user-content-fnref-10">17</a></sup></p><section class="footnotes" data-footnotes=""><h2 id="footnote-label" class="sr-only">Footnotes</h2><ol><li id="user-content-fn-1"><p>Linux kernel ‚Äúearly_dump_pci_devices‚Äù method checking whether the device exists using the class field. <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/pci/early.c?id=refs/tags/v3.12.7#n96">https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/pci/early.c?id=refs/tags/v3.12.7#n96</a> <a href="#user-content-fnref-1" class="data-footnote-backref" aria-label="Back to reference 1" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-2"><p>OSDev PCI page. <a href="https://wiki.osdev.org/PCI">https://wiki.osdev.org/PCI</a> <a href="#user-content-fnref-2" class="data-footnote-backref" aria-label="Back to reference 2" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-3"><p>Site showing the PCI device classes and subclasses. <a href="https://pci-ids.ucw.cz/read/PD/">https://pci-ids.ucw.cz/read/PD/</a> <a href="#user-content-fnref-3" class="data-footnote-backref" aria-label="Back to reference 3" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-4"><p>PCI Local Bus Specification from 2004. <a href="https://lekensteyn.nl/files/docs/PCI_SPEV_V3_0.pdf">https://lekensteyn.nl/files/docs/PCI_SPEV_V3_0.pdf</a> <a href="#user-content-fnref-4" class="data-footnote-backref" aria-label="Back to reference 4" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-5"><p>Bare-metal x86 Rust target, thanks phip1611. <a href="https://stackoverflow.com/questions/67902309/how-to-compile-rust-code-to-bare-metal-32-bit-x86-i686-code-what-compile-targ">https://stackoverflow.com/questions/67902309/how-to-compile-rust-code-to-bare-metal-32-bit-x86-i686-code-what-compile-targ</a> <a href="#user-content-fnref-5" class="data-footnote-backref" aria-label="Back to reference 5" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-6"><p>Writing an OS in Rust: <a href="https://os.phil-opp.com/freestanding-rust-binary/">https://os.phil-opp.com/freestanding-rust-binary/</a> <a href="#user-content-fnref-6" class="data-footnote-backref" aria-label="Back to reference 6" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-7"><p>TechTarget high level description of PATA and SATA interfaces. <a href="https://www.techtarget.com/searchstorage/definition/IDE">https://www.techtarget.com/searchstorage/definition/IDE</a> <a href="#user-content-fnref-7" class="data-footnote-backref" aria-label="Back to reference 7" data-footnote-backref="">‚Ü©</a> <a href="#user-content-fnref-7-2" class="data-footnote-backref" aria-label="Back to reference 7-2" data-footnote-backref="">‚Ü©<sup>2</sup></a> <a href="#user-content-fnref-7-3" class="data-footnote-backref" aria-label="Back to reference 7-3" data-footnote-backref="">‚Ü©<sup>3</sup></a></p></li><li id="user-content-fn-8"><p>OSDev PCI IDE Controller article. <a href="https://wiki.osdev.org/PCI_IDE_Controller">https://wiki.osdev.org/PCI_IDE_Controller</a> <a href="#user-content-fnref-8" class="data-footnote-backref" aria-label="Back to reference 8" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-9"><p>PCI IDE Controller Specification. <a href="http://www.isdaman.com/alsos/hardware/hdc/pciide.pdf">http://www.isdaman.com/alsos/hardware/hdc/pciide.pdf</a> <a href="#user-content-fnref-9" class="data-footnote-backref" aria-label="Back to reference 9" data-footnote-backref="">‚Ü©</a> <a href="#user-content-fnref-9-2" class="data-footnote-backref" aria-label="Back to reference 9-2" data-footnote-backref="">‚Ü©<sup>2</sup></a></p></li><li id="user-content-fn-11"><p>Dell article on SATA vs AHCI. <a href="https://www.dell.com/support/kbdoc/en-us/000127508/difference-between-ahci-and-sata">https://www.dell.com/support/kbdoc/en-us/000127508/difference-between-ahci-and-sata</a> <a href="#user-content-fnref-11" class="data-footnote-backref" aria-label="Back to reference 10" data-footnote-backref="">‚Ü©</a> <a href="#user-content-fnref-11-2" class="data-footnote-backref" aria-label="Back to reference 10-2" data-footnote-backref="">‚Ü©<sup>2</sup></a></p></li><li id="user-content-fn-12"><p>RTEMS guide for PCI IDE drivers. <a href="https://docs.rtems.org/branches/master/bsp-howto/ide_controller.html">https://docs.rtems.org/branches/master/bsp-howto/ide_controller.html</a> <a href="#user-content-fnref-12" class="data-footnote-backref" aria-label="Back to reference 11" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-13"><p>RTEMS PCI IDE driver reference implementation. <a href="https://github.com/RTEMS/rtems/tree/master/bsps/shared/dev/ide">https://github.com/RTEMS/rtems/tree/master/bsps/shared/dev/ide</a> <a href="#user-content-fnref-13" class="data-footnote-backref" aria-label="Back to reference 12" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-16"><p>RTEMS ATA driver guide. <a href="https://docs.rtems.org/branches/master/bsp-howto/ata.html">https://docs.rtems.org/branches/master/bsp-howto/ata.html</a> <a href="#user-content-fnref-16" class="data-footnote-backref" aria-label="Back to reference 13" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-17"><p>OSDev ATA driver. <a href="https://github.com/levex/osdev/blob/master/drivers/ata.c">https://github.com/levex/osdev/blob/master/drivers/ata.c</a> <a href="#user-content-fnref-17" class="data-footnote-backref" aria-label="Back to reference 14" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-14"><p>Stack Overflow on adding a SATA drive to QEMU. <a href="https://stackoverflow.com/questions/48351096/how-to-emulate-a-sata-disk-drive-in-qemu">https://stackoverflow.com/questions/48351096/how-to-emulate-a-sata-disk-drive-in-qemu</a> <a href="#user-content-fnref-14" class="data-footnote-backref" aria-label="Back to reference 15" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-15"><p>Ruben Schade on adding a SATA drive to QEMU. <a href="https://rubenerd.com/sata-on-qemu/">https://rubenerd.com/sata-on-qemu/</a> <a href="#user-content-fnref-15" class="data-footnote-backref" aria-label="Back to reference 16" data-footnote-backref="">‚Ü©</a></p></li><li id="user-content-fn-10"><p>Example of a PCI IDE controller card vendor specification. <a href="https://pdf.dzsc.com/PC8/PC87410.pdf">https://pdf.dzsc.com/PC8/PC87410.pdf</a> <a href="#user-content-fnref-10" class="data-footnote-backref" aria-label="Back to reference 17" data-footnote-backref="">‚Ü©</a></p></li></ol></section></div><div class="flex flex-col justify-between max-w-3xl mx-auto sm:flex-row sm:px-6 mt-8 px-6" data-astro-cid-wo4vtnkt><ul class="mr-5 rtl:ml-5 rtl:mr-0"><li class="mb-2 font-medium bg-gray-100 dark:bg-slate-700 inline-block lowercase mr-2 px-2 py-0.5 rtl:ml-2 rtl:mr-0"><a href="/tag/c" class="text-muted dark:hover:text-gray-200 dark:text-slate-300 hover:text-primary">c</a></li></ul><div class="align-middle dark:text-slate-600 mt-5 sm:mt-1 text-gray-500"><span class="font-bold align-super dark:text-slate-400 text-gray-400">Share:</span> <button class="rtl:ml-0 ml-2 rtl:mr-2" data-aw-social-share="twitter" data-aw-url="https://pagekey.io/blog/2023/pkos-21" title="Twitter Share" data-aw-text="OS21: More PCI + Getting Started with Storage (IDE, SATA)"><svg class="w-6 h-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" data-icon="tabler:brand-x" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:brand-x"><path d="m4 4l11.733 16H20L8.267 4zm0 16l6.768-6.768m2.46-2.46L20 4" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></symbol><use xlink:href="#ai:tabler:brand-x"></use></svg></button> <button class="rtl:ml-0 ml-2 rtl:mr-2" data-aw-social-share="facebook" data-aw-url="https://pagekey.io/blog/2023/pkos-21" title="Facebook Share"><svg class="w-6 h-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" data-icon="tabler:brand-facebook" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:brand-facebook"><path d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 0 1 1-1h3V3h-3a5 5 0 0 0-5 5v2z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></symbol><use xlink:href="#ai:tabler:brand-facebook"></use></svg></button> <button class="rtl:ml-0 ml-2 rtl:mr-2" data-aw-social-share="linkedin" data-aw-url="https://pagekey.io/blog/2023/pkos-21" title="Linkedin Share" data-aw-text="OS21: More PCI + Getting Started with Storage (IDE, SATA)"><svg class="w-6 h-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" data-icon="tabler:brand-linkedin" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:brand-linkedin"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M4 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm4 5v5m0-8v.01M12 16v-5"/><path d="M16 16v-3a2 2 0 0 0-4 0"/></g></symbol><use xlink:href="#ai:tabler:brand-linkedin"></use></svg></button> <button class="rtl:ml-0 ml-2 rtl:mr-2" data-aw-social-share="whatsapp" data-aw-url="https://pagekey.io/blog/2023/pkos-21" title="Whatsapp Share" data-aw-text="OS21: More PCI + Getting Started with Storage (IDE, SATA)"><svg class="w-6 h-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" data-icon="tabler:brand-whatsapp" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:brand-whatsapp"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="m3 21l1.65-3.8a9 9 0 1 1 3.4 2.9z"/><path d="M9 10a.5.5 0 0 0 1 0V9a.5.5 0 0 0-1 0za5 5 0 0 0 5 5h1a.5.5 0 0 0 0-1h-1a.5.5 0 0 0 0 1"/></g></symbol><use xlink:href="#ai:tabler:brand-whatsapp"></use></svg></button> <button class="rtl:ml-0 ml-2 rtl:mr-2" data-aw-social-share="mail" data-aw-url="https://pagekey.io/blog/2023/pkos-21" title="Email Share" data-aw-text="OS21: More PCI + Getting Started with Storage (IDE, SATA)"><svg class="w-6 h-6 dark:hover:text-slate-300 dark:text-slate-500 hover:text-black text-gray-400" data-icon="tabler:mail" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:mail"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="m3 7l9 6l9-6"/></g></symbol><use xlink:href="#ai:tabler:mail"></use></svg></button></div></div></article><div data-astro-cid-wo4vtnkt id="blog-sidebar"><b data-astro-cid-wo4vtnkt>Contents</b><ul data-astro-cid-wo4vtnkt id="ul-contents"><li data-astro-cid-wo4vtnkt><a href="#top" data-astro-cid-wo4vtnkt>Top</a></li></ul></div></section><div class="mx-auto sm:px-6 max-w-3xl px-6 md:pb-20 md:pt-4 pb-12 pt-8"><a href="/blog" class="btn btn-tertiary md:px-3 px-3"><svg class="h-5 w-5 -ml-1.5 mr-1 rtl:-mr-1.5 rtl:ml-1" data-icon="tabler:chevron-left" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:chevron-left"><path d="m15 6l-6 6l6 6" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></symbol><use xlink:href="#ai:tabler:chevron-left"></use></svg> Back to Blog</a></div><section class="relative not-prose scroll-mt-[72px]"><div class="absolute inset-0 pointer-events-none -z-[1]" aria-hidden="true"><div class="absolute inset-0"></div></div><div class="mx-auto px-4 max-w-7xl relative lg:pt-0 lg:py-20 md:pt-0 md:px-6 md:py-16 pt-0 py-12 text-default"><div class="flex flex-col lg:flex-row lg:justify-between mb-8"><div class="md:max-w-sm"><h2 class="mb-2 font-bold font-heading group sm:leading-none sm:text-4xl text-3xl tracking-tight">Related Posts</h2><a href="/blog" class="text-muted transition block dark:text-slate-400 duration-200 ease-in hover:text-primary lg:mb-0 mb-6">View All Posts ¬ª</a></div></div><div class="grid -mb-6 gap-6 lg:grid-cols-4 md:grid-cols-2 row-gap-5"><article class="transition mb-6"><div class="dark:bg-slate-700 bg-gray-400 rounded shadow-lg mb-6 md:h-64 relative"><a href="/blog/2020/pkos/8"><img alt="OS8: Calling C from Assembly" decoding="async" height="225" loading="lazy" src="http://i3.ytimg.com/vi/5RWjI83C47k/hqdefault.jpg" width="400" class="w-full bg-gray-400 dark:bg-slate-700 md:h-full rounded shadow-lg" sizes="(max-width: 900px) 400px, 900px" style="object-fit:cover;object-position:center;max-width:100%;max-height:100%"></a></div><h3 class="mb-2 font-bold font-heading leading-tight sm:text-2xl text-xl"><a href="/blog/2020/pkos/8" class="transition duration-200 ease-in hover:text-primary dark:hover:text-blue-700">OS8: Calling C from Assembly</a></h3><p class="text-muted dark:text-slate-400 text-lg"></p></article><article class="transition mb-6"><div class="dark:bg-slate-700 bg-gray-400 rounded shadow-lg mb-6 md:h-64 relative"><a href="/blog/2024/stream/8"><img alt="PKOS: Finishing up VGA Improvements - Stream 8" decoding="async" height="225" loading="lazy" src="http://i3.ytimg.com/vi/Gd9qGMlqYfc/hqdefault.jpg" width="400" class="w-full bg-gray-400 dark:bg-slate-700 md:h-full rounded shadow-lg" sizes="(max-width: 900px) 400px, 900px" style="object-fit:cover;object-position:center;max-width:100%;max-height:100%"></a></div><h3 class="mb-2 font-bold font-heading leading-tight sm:text-2xl text-xl"><a href="/blog/2024/stream/8" class="transition duration-200 ease-in hover:text-primary dark:hover:text-blue-700">PKOS: Finishing up VGA Improvements - Stream 8</a></h3><p class="text-muted dark:text-slate-400 text-lg"></p></article><article class="transition mb-6"><div class="dark:bg-slate-700 bg-gray-400 rounded shadow-lg mb-6 md:h-64 relative"><a href="/blog/2024/stream/9"><img alt="Pesky VGA... (PKOS) - Stream 9" decoding="async" height="225" loading="lazy" src="http://i3.ytimg.com/vi/WKel56TQTpY/hqdefault.jpg" width="400" class="w-full bg-gray-400 dark:bg-slate-700 md:h-full rounded shadow-lg" sizes="(max-width: 900px) 400px, 900px" style="object-fit:cover;object-position:center;max-width:100%;max-height:100%"></a></div><h3 class="mb-2 font-bold font-heading leading-tight sm:text-2xl text-xl"><a href="/blog/2024/stream/9" class="transition duration-200 ease-in hover:text-primary dark:hover:text-blue-700">Pesky VGA... (PKOS) - Stream 9</a></h3><p class="text-muted dark:text-slate-400 text-lg"></p></article><article class="transition mb-6"><div class="dark:bg-slate-700 bg-gray-400 rounded shadow-lg mb-6 md:h-64 relative"><a href="/blog/2020/90-sec/opengl-glut-linux"><img alt="‚â§90s: First OpenGL Program with GLUT (Linux)" decoding="async" height="225" loading="lazy" src="http://i3.ytimg.com/vi/cShqFtmDTQE/hqdefault.jpg" width="400" class="w-full bg-gray-400 dark:bg-slate-700 md:h-full rounded shadow-lg" sizes="(max-width: 900px) 400px, 900px" style="object-fit:cover;object-position:center;max-width:100%;max-height:100%"></a></div><h3 class="mb-2 font-bold font-heading leading-tight sm:text-2xl text-xl"><a href="/blog/2020/90-sec/opengl-glut-linux" class="transition duration-200 ease-in hover:text-primary dark:hover:text-blue-700">‚â§90s: First OpenGL Program with GLUT (Linux)</a></h3><p class="text-muted dark:text-slate-400 text-lg"></p></article></div></div></section></main><footer class="relative not-prose border-gray-200 border-t dark:border-slate-800"><div class="absolute inset-0 pointer-events-none dark:bg-dark" aria-hidden="true"></div><div class="mx-auto sm:px-6 px-4 dark:text-slate-300 max-w-7xl relative"><div class="grid gap-4 gap-y-8 grid-cols-12 md:py-12 py-8 sm:gap-8"><div class="col-span-12 lg:col-span-4"><div class="mb-2"><a href="/" class="font-bold text-xl inline-block">PageKey</a></div><div class="text-muted text-sm"></div></div><div class="col-span-6 lg:col-span-2 md:col-span-3"><div class="mb-2 font-medium dark:text-gray-300">Products</div><ul class="text-sm"><li class="mb-2"><a href="/products/boom" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">Boom Languages</a></li><li class="mb-2"><a href="/products/keydo" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">KeyDo</a></li><li class="mb-2"><a href="/products/keyreader" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">KeyReader</a></li><li class="mb-2"><a href="/products/pkos" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">PageKey Operating System</a></li><li class="mb-2"><a href="/products/pkvid" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">PKVid</a></li><li class="mb-2"><a href="/products/ptd" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">Plaintext DAW</a></li></ul></div><div class="col-span-6 lg:col-span-2 md:col-span-3"><div class="mb-2 font-medium dark:text-gray-300">Community</div><ul class="text-sm"><li class="mb-2"><a href="https://github.com/pagekey" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">GitHub</a></li><li class="mb-2"><a href="https://discord.gg/5m5yFgDPF5" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">Discord</a></li><li class="mb-2"><a href="https://youtube.com/@PageKey" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">YouTube</a></li></ul></div><div class="col-span-6 lg:col-span-2 md:col-span-3"><div class="mb-2 font-medium dark:text-gray-300">Tags</div><ul class="text-sm"><li class="mb-2"><a href="/blog/tags" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">All Tags</a></li><li class="mb-2"><a href="/tag/python" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">Python</a></li><li class="mb-2"><a href="/tag/rust" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">Rust</a></li></ul></div><div class="col-span-6 lg:col-span-2 md:col-span-3"><div class="mb-2 font-medium dark:text-gray-300">Languages</div><ul class="text-sm"><li class="mb-2"><a href="/blog" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">English</a></li><li class="mb-2"><a href="/tag/spanish" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">Espa√±ol</a></li><li class="mb-2"><a href="/tag/russian" class="text-muted dark:text-gray-400 duration-150 ease-in-out hover:text-gray-700 hover:underline transition">–†—É—Å—Å–∫–∏–π</a></li></ul></div></div><div class="md:items-center md:flex md:justify-between md:py-8 py-6"><ul class="flex -ml-2 mb-4 md:mb-0 md:ml-4 md:order-1 rtl:-mr-2 rtl:md:ml-0 rtl:md:mr-4 rtl:ml-0"><li><a href="https://discord.gg/5m5yFgDPF5" class="text-muted dark:text-gray-400 dark:focus:ring-gray-700 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex items-center p-2.5 rounded-lg text-sm" aria-label="Discord"><svg class="h-5 w-5" data-icon="tabler:brand-discord" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:brand-discord"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M8 12a1 1 0 1 0 2 0a1 1 0 0 0-2 0m6 0a1 1 0 1 0 2 0a1 1 0 0 0-2 0"/><path d="M15.5 17c0 1 1.5 3 2 3c1.5 0 2.833-1.667 3.5-3c.667-1.667.5-5.833-1.5-11.5c-1.457-1.015-3-1.34-4.5-1.5l-.972 1.923a11.913 11.913 0 0 0-4.053 0L9 4c-1.5.16-3.043.485-4.5 1.5c-2 5.667-2.167 9.833-1.5 11.5c.667 1.333 2 3 3.5 3c.5 0 2-2 2-3"/><path d="M7 16.5c3.5 1 6.5 1 10 0"/></g></symbol><use xlink:href="#ai:tabler:brand-discord"></use></svg></a></li><li><a href="https://youtube.com/@PageKey" class="text-muted dark:text-gray-400 dark:focus:ring-gray-700 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex items-center p-2.5 rounded-lg text-sm" aria-label="YouTube"><svg class="h-5 w-5" data-icon="tabler:brand-youtube" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:brand-youtube"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M2 8a4 4 0 0 1 4-4h12a4 4 0 0 1 4 4v8a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4z"/><path d="m10 9l5 3l-5 3z"/></g></symbol><use xlink:href="#ai:tabler:brand-youtube"></use></svg></a></li><li><a href="https://github.com/pagekey" class="text-muted dark:text-gray-400 dark:focus:ring-gray-700 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex items-center p-2.5 rounded-lg text-sm" aria-label="Github"><svg class="h-5 w-5" data-icon="tabler:brand-github" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:brand-github"><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2c2.8-.3 5.5-1.4 5.5-6a4.6 4.6 0 0 0-1.3-3.2a4.2 4.2 0 0 0-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3 0 0 0-6.2 0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2 0 0 0-.1 3.2A4.6 4.6 0 0 0 4 9.5c0 4.6 2.7 5.7 5.5 6c-.6.6-.6 1.2-.5 2V21" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></symbol><use xlink:href="#ai:tabler:brand-github"></use></svg></a></li><li><a href="https://instagram.com/pagekeysolutions" class="text-muted dark:text-gray-400 dark:focus:ring-gray-700 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex items-center p-2.5 rounded-lg text-sm" aria-label="Instagram"><svg class="h-5 w-5" data-icon="tabler:brand-instagram" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:brand-instagram"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M4 8a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v8a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4z"/><path d="M9 12a3 3 0 1 0 6 0a3 3 0 1 0-6 0m7.5-4.5v.01"/></g></symbol><use xlink:href="#ai:tabler:brand-instagram"></use></svg></a></li><li><a href="/rss.xml" class="text-muted dark:text-gray-400 dark:focus:ring-gray-700 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex items-center p-2.5 rounded-lg text-sm" aria-label="RSS"><svg class="h-5 w-5" data-icon="tabler:rss" height="1em" viewBox="0 0 24 24" width="1em"><symbol id="ai:tabler:rss"><path d="M4 19a1 1 0 1 0 2 0a1 1 0 1 0-2 0M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></symbol><use xlink:href="#ai:tabler:rss"></use></svg></a></li></ul><div class="dark:text-muted mr-4 text-sm"><span class="h-5 w-5 bg-[url(/favicon.ico)] bg-cover float-left md:-mt-0.5 md:h-6 md:w-6 mr-1.5 rounded-sm rtl:float-right rtl:ml-1.5 rtl:mr-0"></span> Copyright &copy; 2024 PageKey Solutions, LLC ¬∑ All rights reserved.</div></div></div></footer><script>!function(){const e="system";if(window.basic_script)return;function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}window.basic_script=!0;const d=function(){e&&e.endsWith(":only")||(localStorage.theme,0)?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light")};function a(e,t,d){const a="string"==typeof e?document.querySelectorAll(e):e;a&&a.length&&a.forEach((e=>{e.addEventListener(t,(t=>d(t,e)),!1)}))}d();const o=function(){let t=window.scrollY,d=!0;function o(){const e=document.querySelector("#header[data-aw-sticky-header]");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),d=!1}a("#header nav","click",(function(){document.querySelector("[data-aw-toggle-menu]")?.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.getElementById("header")?.classList.remove("expanded"),document.getElementById("header")?.classList.remove("bg-page"),document.querySelector("#header nav")?.classList.add("hidden"),document.querySelector("#header > div > div:last-child")?.classList.add("hidden")})),a("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.getElementById("header")?.classList.toggle("expanded"),document.getElementById("header")?.classList.toggle("bg-page"),document.querySelector("#header nav")?.classList.toggle("hidden"),document.querySelector("#header > div > div:last-child")?.classList.toggle("hidden")})),a("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light")})),a("[data-aw-social-share]","click",(function(e,t){const d=t.getAttribute("data-aw-social-share"),a=encodeURIComponent(t.getAttribute("data-aw-url")),o=encodeURIComponent(t.getAttribute("data-aw-text"));let n;switch(d){case"facebook":n=`https://www.facebook.com/sharer.php?u=${a}`;break;case"twitter":n=`https://twitter.com/intent/tweet?url=${a}&text=${o}`;break;case"linkedin":n=`https://www.linkedin.com/shareArticle?mini=true&url=${a}&title=${o}`;break;case"whatsapp":n=`https://wa.me/?text=${o}%20${a}`;break;case"mail":n=`mailto:?subject=%22${o}%22&body=${o}%20${a}`;break;default:return}const c=document.createElement("a");c.target="_blank",c.href=n,c.click()})),window.matchMedia("(max-width: 767px)").addEventListener("change",(function(){document.querySelector("[data-aw-toggle-menu]")?.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.getElementById("header")?.classList.remove("expanded"),document.getElementById("header")?.classList.remove("bg-page"),document.querySelector("#header nav")?.classList.add("hidden"),document.querySelector("#header > div > div:last-child")?.classList.add("hidden")})),o(),a([document],"scroll",(function(){t=window.scrollY,d||(window.requestAnimationFrame((()=>{o()})),d=!0)}))},n=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.getElementById("header")?.classList.remove("expanded"),document.querySelector("#header nav")?.classList.add("hidden")};window.onload=o,window.onpageshow=n,document.addEventListener("astro:after-swap",(()=>{d(),o(),n()}))}()</script><script type="module">import mermaid from"https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";async function renderDiagrams(e){mermaid.initialize({startOnLoad:!1,fontFamily:"var(--sans-font)",theme:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"default"});for(const m of e){const e=m.querySelector(".mermaid-src").innerText;if(!e)continue;let r=document.createElement("svg");const a=r.id="mermaid-"+Math.round(1e5*Math.random());m.appendChild(r),mermaid.render(a,e).then((e=>{m.innerHTML=e.svg}))}}const graphs=document.getElementsByClassName("mermaid");document.getElementsByClassName("mermaid").length>0&&renderDiagrams(graphs)</script></body></html><script async src="https://www.googletagmanager.com/gtag/js?id=G-LCGN32XDMX"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-LCGN32XDMX")</script>